import json
import re
import os
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage

# OpenAI API í‚¤ (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# OpenAI LLM ì´ˆê¸°í™”
llm = ChatOpenAI(
    api_key=OPENAI_API_KEY,
    model="gpt-4o-mini",
    max_tokens=4000,
    temperature=0.3,
)


def generate_response(prompt: str, system_message: str = "") -> str:
    """OpenAI LLMìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ì‘ë‹µ ìƒì„±"""
    messages = []
    if system_message:
        messages.append(SystemMessage(content=system_message))
    messages.append(HumanMessage(content=prompt))

    response = llm.invoke(messages)
    return response.content


def extract_json_block(text: str) -> str:
    """LLM ì‘ë‹µì—ì„œ JSON ë¸”ë¡ë§Œ ì¶”ì¶œ"""
    # ```json ... ``` í˜•íƒœ ì²˜ë¦¬
    if "```json" in text:
        text = text.split("```json", 1)[1].split("```", 1)[0]
    elif "```" in text:
        text = text.split("```", 1)[1].split("```", 1)[0]

    text = text.strip()

    # ì²« ë²ˆì§¸ {...} ë¸”ë¡ë§Œ ì¶”ì¶œ
    match = re.search(r"\{[\s\S]*\}", text)
    if not match:
        raise ValueError("JSON ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    return match.group()


def generate_docheong_json(content: str) -> dict:
    """
    ììœ  í˜•ì‹ íšŒì˜ ë‚´ìš© â†’ ë„ì²­ ë™í–¥ë³´ê³ ì„œ JSON ë³€í™˜

    âš ï¸ ì£¼ì˜: ë°˜í™˜ í˜•ì‹ì€ ë°˜ë“œì‹œ DocheongReportì™€ ë§ì¶°ì•¼ í•¨.
      {
        "title": "ë³´ê³ ì„œ ì œëª©",
        "overview": [ "...", ... ],
        "test_status": [ "...", ... ],
        "key_issues": [ "...", ... ],
        "followup": [ "...", ... ]
      }
    ê° ë¦¬ìŠ¤íŠ¸ ìš”ì†ŒëŠ” ë¬¸ìì—´ í•œ ì¤„.
    """
    system_message = """
ë‹¹ì‹ ì€ ì „ë¼ë¶ë„ì²­ì˜ í–‰ì •Â·ì—…ë¬´ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì´ë‹¤.
ì‚¬ìš©ìê°€ ì…ë ¥í•œ íšŒì˜/ìƒí™© ì„¤ëª…ì„ ì½ê³ , ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ **ê°œì¡°ì‹Â·ë³´ê³ ì„œ ë¬¸ì²´**ë¡œ ì •ë¦¬í•˜ë¼.

ë°˜ë“œì‹œ ì•„ë˜ **í‚¤ ì´ë¦„ê³¼ ìë£Œí˜•**ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

{
  "title": "ë³´ê³ ì„œ ì œëª©(ì§§ê²Œ ìš”ì•½)",
  "overview": [
    "â—‹ (í•­ëª©ëª…1) í•œ ì¤„ ìš”ì•½ ë¬¸ì¥",
    "    - í•„ìš”í•˜ë©´ ì„¸ë¶€ ì„¤ëª… í•œ ì¤„",
    "    â€» ë¹„ê³ ê°€ ìˆìœ¼ë©´ ì´ë ‡ê²Œ í•œ ì¤„"
  ],
  "test_status": [
    "â—‹ (í˜„ì¬ í˜„í™©1) í•œ ì¤„ ìš”ì•½",
    "    - ì„¸ë¶€ ìƒí™©"
  ],
  "key_issues": [
    "â—‹ (ì´ìŠˆ1) í•œ ì¤„ ìš”ì•½",
    "â—‹ (ì´ìŠˆ2) í•œ ì¤„ ìš”ì•½"
  ],
  "followup": [
    "â—‹ (í–¥í›„ ê³„íš1) í•œ ì¤„ ìš”ì•½",
    "â—‹ (í–¥í›„ ê³„íš2) í•œ ì¤„ ìš”ì•½"
  ]
}

[ì„¹ì…˜ ì˜ë¯¸]
- overview    : ì „ì²´ ë°°ê²½Â·ê°œê´„ ì„¤ëª…, ì¤‘ìš”í•œ ì „ë°˜ ìƒí™© ìš”ì•½
- test_status : í˜„ì¬ ì§„í–‰ í˜„í™©Â·ìƒíƒœ (ì„œë¹„ìŠ¤ë©´ í…ŒìŠ¤íŠ¸ í˜„í™©, ì‚¬ëŒ ì´ì•¼ê¸°ë©´ í˜„ì¬ í™œë™ íŒ¨í„´ ë“±)
- key_issues  : ë¬¸ì œì , ìŸì , ë¦¬ìŠ¤í¬
- followup    : í–¥í›„ ê³„íš, í•„ìš”í•œ ì¡°ì¹˜, ì•¡ì…˜ ì•„ì´í…œ

[í•­ëª© ì´ë¦„(ê´„í˜¸ ì•ˆ í…ìŠ¤íŠ¸) ì‘ì„± ê°€ì´ë“œ]
- ì„œë¹„ìŠ¤/í…ŒìŠ¤íŠ¸ ê´€ë ¨ ì£¼ì œì¸ ê²½ìš° ì˜ˆì‹œ:
    overview    : "â—‹ (ìš´ì˜ê¸°ê°„) ...", "â—‹ (í™ë³´ë°©ë²•) ..."
    test_status : "â—‹ (ì ‘ì†ììˆ˜) ...", "â—‹ (ì‚¬ìš©í† í°) ..."
- ê°œì¸ ì·¨ë¯¸Â·ì—…ë¬´ íšŒì˜ ë“± ë‹¤ë¥¸ ì£¼ì œì¸ ê²½ìš° ìƒí™©ì— ë§ëŠ” ì´ë¦„ìœ¼ë¡œ ì‘ì„±:
    overview    : "â—‹ (ì·¨ë¯¸ í™œë™ ê°œìš”) ...", "â—‹ (íšŒì˜ ê°œìš”) ..."
    test_status : "â—‹ (í˜„ì¬ ì·¨ë¯¸ í˜„í™©) ...", "â—‹ (í˜„ì¬ ì¶”ì§„ í˜„í™©) ..."
    key_issues  : "â—‹ (ì‹œê°„ ë¶€ì¡± ë¬¸ì œ) ...", "â—‹ (í˜‘ì—… ì´ìŠˆ) ..."
    followup    : "â—‹ (íœ´ì‹ì¼ ì„¤ì • ê³„íš) ...", "â—‹ (í–¥í›„ ì§€ì› ë°©ì•ˆ) ..."

[ë¬¸ì²´Â·í˜•ì‹ ê·œì¹™ â€” ê°œì¡°ì‹Â·ë³´ê³ ì„œ ìŠ¤íƒ€ì¼]
1. ëª¨ë“  ë¬¸ì¥ì€ **ê°œì¡°ì‹ ë¬¸ì²´**ë¡œ ì‘ì„±í•  ê²ƒ.
   - ë¬¸ì¥ ëì€ ê°€ê¸‰ì  "~í•¨", "~ì„", "~í•„ìš”", "~ê³„íšì„" ë“± **ì²´ì–¸+ì´ë‹¤ / ëª…ì‚¬í˜•**ìœ¼ë¡œ ë§ˆë¬´ë¦¬.
   - ì˜ˆ: "ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ ìˆ˜ë‹¨ìœ¼ë¡œ í™œìš© ì¤‘ì„", "ì‹œê°„ ê´€ë¦¬ ë³´ì™„ í•„ìš”", "ì¶”ê°€ ì˜ˆì‚° ê²€í†  ê³„íšì„".
2. **ë¬¸ì¥ ëì— ë§ˆì¹¨í‘œ( . )ë¥¼ ë¶™ì´ì§€ ë§ ê²ƒ.**
   - "â€¦ì¤‘ì„.", "â€¦í•„ìš”." ì²˜ëŸ¼ ëì— ì ì„ ì°ì§€ ë§ê³ 
   - "â€¦ì¤‘ì„", "â€¦í•„ìš”" í˜•íƒœë¡œ ëë‚¼ ê²ƒ.
3. "~í•©ë‹ˆë‹¤", "~í–ˆìŠµë‹ˆë‹¤" ë“±ì˜ ì„œìˆ ì‹ ì¢…ê²°ì–´ë¯¸ëŠ” ê°€ëŠ¥í•œ í•œ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ.
4. ê° í•­ëª©ì€ í•œ ì¤„ì§œë¦¬ ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ (ë¶ˆí•„ìš”í•œ ìˆ˜ì‹Â·ê°ì • í‘œí˜„ ë°°ì œ).
5. ì£¼ê´€ì Â·ê°ìƒì  í‘œí˜„ì€ í”¼í•˜ê³ , **ì‚¬ì‹¤Â·ê´€ì°°Â·ê³„íš ì¤‘ì‹¬**ìœ¼ë¡œ ì •ë¦¬í•  ê²ƒ.

[í˜•ì‹ ê·œì¹™ â€” JSON êµ¬ì¡°]
1. JSONì˜ ìµœìƒìœ„ í‚¤ëŠ” **ë°˜ë“œì‹œ** ë‹¤ìŒ ë‹¤ì„¯ ê°œë§Œ ì¡´ì¬í•´ì•¼ í•œë‹¤:
   - "title", "overview", "test_status", "key_issues", "followup"
2. ê° ì„¹ì…˜ ê°’ì€ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸(list[str])ì—¬ì•¼ í•œë‹¤.
3. ê° í•­ëª©ì€ í•­ìƒ "â—‹ "ë¡œ ì‹œì‘í•˜ê³ , ê´„í˜¸ ì•ˆì˜ í•­ëª©ëª…ì€ ìƒí™©ì— ë§ê²Œ **êµ¬ì²´ì ì¸ ì´ë¦„**ìœ¼ë¡œ ì‘ì„±í•œë‹¤.
   - ì˜ˆ: "â—‹ (ìš´ì˜ê¸°ê°„) ...", "â—‹ (í™ë³´ë°©ë²•) ...",
         "â—‹ (ì·¨ë¯¸ í™œë™ í˜„í™©) ...", "â—‹ (í•µì‹¬ ì´ìŠˆ) ..."
4. ì„¸ë¶€ ì„¤ëª…ì´ í•„ìš”í•˜ë©´ ê°™ì€ ì„¹ì…˜ ì•ˆì—
   - "    - " ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ìì—´ì„ ì¶”ê°€í•œë‹¤. (ìµœëŒ€ í•œë‘ ì¤„ ì •ë„ë¡œ ì§§ê²Œ)
5. ë¹„ê³ ê°€ í•„ìš”í•˜ë©´
   - "    â€» " ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ìì—´ì„ ì¶”ê°€í•œë‹¤.
6. ì–´ë–¤ ì„¹ì…˜ì— ë„£ì„ ë‚´ìš©ì´ ì—†ìœ¼ë©´, ê·¸ ì„¹ì…˜ì€ ë¹ˆ ë¦¬ìŠ¤íŠ¸ [] ë¡œ ë‘”ë‹¤.
7. ê° ë¬¸ìì—´ì€ **í•œ ì¤„ì§œë¦¬ ë¬¸ì¥**ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì¤„ë°”ê¿ˆ ë¬¸ì("\\n")ëŠ” í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.
8. ì„¤ëª… í…ìŠ¤íŠ¸ëŠ” JSON ë°”ê¹¥ì— ì“°ì§€ ë§ê³ , **JSON ì „ì²´ë§Œ** ê·¸ëŒ€ë¡œ ë°˜í™˜í•œë‹¤.
"""

    prompt = f"""ë‹¤ìŒ íšŒì˜/ìƒí™© ì„¤ëª…ì„ ì½ê³  ìœ„ì—ì„œ ì§€ì •í•œ í˜•ì‹ì˜ JSONì„ ìƒì„±í•˜ì„¸ìš”.

ì…ë ¥ í…ìŠ¤íŠ¸:
\"\"\"{content}\"\"\""""

    print("ğŸ¤– OpenAI GPTë¡œ JSON ìƒì„± ì¤‘...")
    response = generate_response(prompt, system_message)

    print("\n=== LLM ì‘ë‹µ ===")
    print(response)
    print("=" * 60 + "\n")

    try:
        json_str = extract_json_block(response)
        raw = json.loads(json_str)

        # í˜¹ì‹œ ë¹ ì§„ ì„¹ì…˜ì´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì±„ì›Œ ë„£ê¸°
        cleaned = {
            "title": raw.get("title", "ë¬´ì œ ë³´ê³ ì„œ"),
            "overview": raw.get("overview", []) or [],
            "test_status": raw.get("test_status", []) or [],
            "key_issues": raw.get("key_issues", []) or [],
            "followup": raw.get("followup", []) or [],
        }

        # ê¸°ë³¸ì ìœ¼ë¡œ list[str] í˜•íƒœë¡œ ë§ì¶”ê¸°
        for key in ["overview", "test_status", "key_issues", "followup"]:
            value = cleaned[key]
            if isinstance(value, str):
                cleaned[key] = [value]
            elif isinstance(value, list):
                cleaned[key] = [str(v) for v in value]
            else:
                cleaned[key] = [str(value)]

        # ğŸ”¹ 2ì°¨ í›„ì²˜ë¦¬: ê° í•­ëª© ëì˜ ë¶ˆí•„ìš”í•œ ë§ˆì¹¨í‘œ(.) ì œê±°
        def strip_trailing_period(s: str) -> str:
            s = s.rstrip()
            # ë§¨ ëì— ìˆëŠ” ë§ˆì¹¨í‘œ ì—°ì† ì œê±° ("...." ê°™ì€ ê²ƒë„ í•œ ë²ˆì— ì œê±°)
            s = re.sub(r"[.]+$", "", s)
            return s.rstrip()

        for key in ["overview", "test_status", "key_issues", "followup"]:
            cleaned[key] = [strip_trailing_period(v) for v in cleaned[key]]

        return cleaned

    except Exception as e:
        raise RuntimeError(f"âŒ JSON íŒŒì‹± ì‹¤íŒ¨: {e}\nì‘ë‹µ:\n{response}")
